openapi: 3.1.0
info:
  title: Bus Ticketing API
  version: 1.0.0
  description: >
    Backend API for Bus Ticketing System using Hono, Prisma, PostgreSQL, Midtrans.
    Provides endpoints for user authentication, booking management, payments, and admin operations.

servers:
  - url: http://localhost:3000
    description: Development server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login or /auth/register

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [ADMIN, USER]
        createdAt:
          type: string
          format: date-time

    Bus:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        plate:
          type: string
        totalSeat:
          type: integer
        createdAt:
          type: string
          format: date-time

    Route:
      type: object
      properties:
        id:
          type: string
          format: uuid
        origin:
          type: string
        destination:
          type: string
        distanceKm:
          type: integer
        createdAt:
          type: string
          format: date-time

    Trip:
      type: object
      properties:
        id:
          type: string
          format: uuid
        busId:
          type: string
          format: uuid
        routeId:
          type: string
          format: uuid
        departureTime:
          type: string
          format: date-time
        arrivalTime:
          type: string
          format: date-time
        price:
          type: integer
        createdAt:
          type: string
          format: date-time
        bus:
          $ref: "#/components/schemas/Bus"
        route:
          $ref: "#/components/schemas/Route"

    Booking:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        tripId:
          type: string
          format: uuid
        status:
          type: string
          enum: [PENDING, PAID, CONFIRMED, EXPIRED, CANCELLED]
        totalPrice:
          type: integer
        expiresAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time

    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        bookingId:
          type: string
          format: uuid
        orderId:
          type: string
        transactionId:
          type: string
          nullable: true
        amount:
          type: integer
        status:
          type: string
          enum: [PENDING, PAID, FAILED]
        rawResponse:
          type: object
          nullable: true
        createdAt:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string

security:
  - BearerAuth: []

paths:
  /auth/register:
    post:
      summary: Register new user
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email, password]
              properties:
                name:
                  type: string
                  example: "John Doe"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  format: password
                  minLength: 6
                  example: "password123"
      responses:
        "200":
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      name:
                        type: string
                      email:
                        type: string
        "400":
          description: Validation error or email already registered
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      summary: User login
      tags: [Auth]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                password:
                  type: string
                  format: password
                  example: "password123"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      name:
                        type: string
                      email:
                        type: string
                      role:
                        type: string
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /booking:
    post:
      summary: Create booking
      tags: [Booking]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [tripId, seatCodes]
              properties:
                tripId:
                  type: string
                  format: uuid
                  example: "123e4567-e89b-12d3-a456-426614174000"
                seatCodes:
                  type: array
                  items:
                    type: string
                  example: ["A1", "A2"]
      responses:
        "200":
          description: Booking created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Booking"
        "400":
          description: Invalid request or seats unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /payment/create:
    post:
      summary: Create Midtrans payment
      tags: [Payment]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [bookingId]
              properties:
                bookingId:
                  type: string
                  format: uuid
                  example: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        "200":
          description: Payment created, returns Midtrans transaction object
          content:
            application/json:
              schema:
                type: object
                properties:
                  payment:
                    type: object
        "400":
          description: Invalid booking or booking not pending
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - not booking owner
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /payment/midtrans/webhook:
    post:
      summary: Midtrans webhook callback
      tags: [Payment]
      security: []
      description: Receives payment status updates from Midtrans
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                order_id:
                  type: string
                transaction_status:
                  type: string
                transaction_id:
                  type: string
      responses:
        "200":
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  ###########
  ## PUBLIC ##
  ###########

  /public/routes:
    get:
      summary: List all routes (public)
      tags: [Public]
      security: []
      responses:
        "200":
          description: List of all routes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Route"

  /public/buses:
    get:
      summary: List all buses (public)
      tags: [Public]
      security: []
      responses:
        "200":
          description: List of all buses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"

  /public/trips:
    get:
      summary: Search trips (public)
      tags: [Public]
      security: []
      description: Search for trips with optional filters
      parameters:
        - name: from
          in: query
          schema:
            type: string
          description: Filter by origin (contains)
          example: "Jakarta"
        - name: to
          in: query
          schema:
            type: string
          description: Filter by destination (contains)
          example: "Bandung"
        - name: date
          in: query
          schema:
            type: string
            format: date
          description: Filter by departure date (YYYY-MM-DD)
          example: "2024-01-20"
      responses:
        "200":
          description: List of trips matching filters
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Trip"

  /public/trips/{id}:
    get:
      summary: Get trip detail with seat availability (public)
      tags: [Public]
      security: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trip details with seat layout
          content:
            application/json:
              schema:
                type: object
                properties:
                  trip:
                    type: object
                    properties:
                      id:
                        type: string
                        format: uuid
                      bus:
                        $ref: "#/components/schemas/Bus"
                      route:
                        $ref: "#/components/schemas/Route"
                      departureTime:
                        type: string
                        format: date-time
                      arrivalTime:
                        type: string
                        format: date-time
                      price:
                        type: integer
                  seats:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        seatCode:
                          type: string
                        isBooked:
                          type: boolean
        "400":
          description: Bad request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Trip not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  ############
  ## BOOKING ##
  ############

  /booking/me:
    get:
      summary: Get my bookings
      tags: [Booking]
      description: Get paginated list of current user's bookings
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: perPage
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        "200":
          description: Paginated booking list
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    type: integer
                  perPage:
                    type: integer
                  total:
                    type: integer
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        userId:
                          type: string
                        tripId:
                          type: string
                        status:
                          type: string
                        totalPrice:
                          type: integer
                        trip:
                          $ref: "#/components/schemas/Trip"
                        seats:
                          type: array
                          items:
                            type: object
                        payment:
                          $ref: "#/components/schemas/Payment"

  /booking/me/upcoming:
    get:
      summary: Get upcoming confirmed bookings
      tags: [Booking]
      description: Get current user's confirmed bookings with future departure times
      responses:
        "200":
          description: List of upcoming bookings
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        userId:
                          type: string
                        tripId:
                          type: string
                        status:
                          type: string
                        totalPrice:
                          type: integer
                        trip:
                          $ref: "#/components/schemas/Trip"
                        seats:
                          type: array
                          items:
                            type: object
                        payment:
                          $ref: "#/components/schemas/Payment"

  /booking/{id}:
    get:
      summary: Get booking detail
      tags: [Booking]
      description: Get detailed booking information (owner or admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Booking details
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  userId:
                    type: string
                  tripId:
                    type: string
                  status:
                    type: string
                  totalPrice:
                    type: integer
                  user:
                    $ref: "#/components/schemas/User"
                  trip:
                    $ref: "#/components/schemas/Trip"
                  seats:
                    type: array
                    items:
                      type: object
                  payment:
                    $ref: "#/components/schemas/Payment"
        "403":
          description: Forbidden - not owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /booking/{id}/cancel:
    post:
      summary: Cancel booking
      tags: [Booking]
      description: Cancel a pending booking (owner or admin only)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Booking cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "400":
          description: Only pending bookings can be cancelled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Forbidden - not owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Booking not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  ############
  ## PAYMENT ##
  ############

  /payment/me:
    get:
      summary: Get my payments
      tags: [Payment]
      description: Get all payments for current user's bookings
      responses:
        "200":
          description: List of user payments
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    bookingId:
                      type: string
                    orderId:
                      type: string
                    transactionId:
                      type: string
                      nullable: true
                    amount:
                      type: integer
                    status:
                      type: string
                    booking:
                      $ref: "#/components/schemas/Booking"
                    createdAt:
                      type: string
                      format: date-time

  ###########
  ## ADMIN ##
  ###########

  /admin/revenue/daily:
    get:
      summary: Get daily revenue
      tags: [Admin - Revenue]
      parameters:
        - name: date
          in: query
          schema:
            type: string
            format: date
          description: Date to get revenue for (defaults to today)
          example: "2024-01-15"
      responses:
        "200":
          description: Daily revenue total
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    format: date-time
                  revenue:
                    type: number

  /admin/revenue/monthly:
    get:
      summary: Get monthly revenue
      tags: [Admin - Revenue]
      parameters:
        - name: year
          in: query
          schema:
            type: integer
          example: 2024
        - name: month
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 12
          example: 1
      responses:
        "200":
          description: Monthly revenue total
          content:
            application/json:
              schema:
                type: object
                properties:
                  year:
                    type: integer
                  month:
                    type: integer
                  revenue:
                    type: number

  /admin/revenue/route:
    get:
      summary: Revenue by route
      tags: [Admin - Revenue]
      responses:
        "200":
          description: Revenue grouped by route
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    route_id:
                      type: string
                    origin:
                      type: string
                    destination:
                      type: string
                    revenue:
                      type: number

  /admin/revenue/bus:
    get:
      summary: Revenue by bus
      tags: [Admin - Revenue]
      responses:
        "200":
          description: Revenue grouped by bus
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    bus_id:
                      type: string
                    name:
                      type: string
                    plate:
                      type: string
                    revenue:
                      type: number

  /admin/bookings:
    get:
      summary: Get paginated booking list
      tags: [Admin - Bookings]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: perPage
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, PAID, CONFIRMED, EXPIRED, CANCELLED]
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - name: routeId
          in: query
          schema:
            type: string
        - name: tripId
          in: query
          schema:
            type: string
      responses:
        "200":
          description: Paginated booking list
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    type: integer
                  perPage:
                    type: integer
                  total:
                    type: integer
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Booking"

  /admin/bookings/stats:
    get:
      summary: Get booking statistics
      tags: [Admin - Bookings]
      responses:
        "200":
          description: Booking statistics summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  counts:
                    type: array
                    items:
                      type: object
                      properties:
                        status:
                          type: string
                        _count:
                          type: object

  /admin/users:
    post:
      summary: Create new user (admin)
      tags: [Admin - Users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 6
                role:
                  type: string
                  enum: [ADMIN, USER]
      responses:
        "200":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      summary: List all users
      tags: [Admin - Users]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: perPage
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
      responses:
        "200":
          description: Paginated user list
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    type: integer
                  perPage:
                    type: integer
                  total:
                    type: integer
                  users:
                    type: array
                    items:
                      $ref: "#/components/schemas/User"

  /admin/users/{id}/promote:
    post:
      summary: Promote or demote user
      tags: [Admin - Users]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role:
                  type: string
                  enum: [ADMIN, USER]
      responses:
        "200":
          description: User role updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/buses:
    post:
      summary: Create new bus
      tags: [Admin - Buses]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, plate, totalSeat]
              properties:
                name:
                  type: string
                  example: "Bus Ekonomi 1"
                plate:
                  type: string
                  example: "B 1234 XYZ"
                totalSeat:
                  type: integer
                  example: 40
      responses:
        "200":
          description: Bus created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      summary: List all buses
      tags: [Admin - Buses]
      responses:
        "200":
          description: List of buses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Bus"

  /admin/buses/{id}:
    put:
      summary: Update bus
      tags: [Admin - Buses]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                plate:
                  type: string
                totalSeat:
                  type: integer
      responses:
        "200":
          description: Bus updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Bus"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete bus
      tags: [Admin - Buses]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Bus deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /admin/routes:
    post:
      summary: Create new route
      tags: [Admin - Routes]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [origin, destination, distanceKm]
              properties:
                origin:
                  type: string
                  example: "Jakarta"
                destination:
                  type: string
                  example: "Bandung"
                distanceKm:
                  type: integer
                  example: 150
      responses:
        "200":
          description: Route created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Route"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      summary: List all routes
      tags: [Admin - Routes]
      responses:
        "200":
          description: List of routes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Route"

  /admin/routes/{id}:
    put:
      summary: Update route
      tags: [Admin - Routes]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                origin:
                  type: string
                destination:
                  type: string
                distanceKm:
                  type: integer
      responses:
        "200":
          description: Route updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Route"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete route
      tags: [Admin - Routes]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Route deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /admin/trips:
    post:
      summary: Create new trip
      tags: [Admin - Trips]
      description: Create trip with optional automatic seat generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [busId, routeId, departureTime, arrivalTime, price]
              properties:
                busId:
                  type: string
                  format: uuid
                routeId:
                  type: string
                  format: uuid
                departureTime:
                  type: string
                  format: date-time
                  example: "2024-01-20T08:00:00Z"
                arrivalTime:
                  type: string
                  format: date-time
                  example: "2024-01-20T12:00:00Z"
                price:
                  type: integer
                  example: 150000
                generateSeats:
                  type: boolean
                  description: Auto-generate seats for this trip
                  example: true
                rows:
                  type: integer
                  description: Number of rows (if generateSeats is true)
                  example: 10
                cols:
                  type: integer
                  description: Number of columns (if generateSeats is true)
                  example: 4
      responses:
        "200":
          description: Trip created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Trip"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    get:
      summary: List all trips
      tags: [Admin - Trips]
      responses:
        "200":
          description: List of trips with bus and route details
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Trip"

  /admin/trips/{id}:
    put:
      summary: Update trip
      tags: [Admin - Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                busId:
                  type: string
                  format: uuid
                routeId:
                  type: string
                  format: uuid
                departureTime:
                  type: string
                  format: date-time
                arrivalTime:
                  type: string
                  format: date-time
                price:
                  type: integer
      responses:
        "200":
          description: Trip updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Trip"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Delete trip
      tags: [Admin - Trips]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Trip deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
